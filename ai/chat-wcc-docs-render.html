<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WCC Docs Chat - Render</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      position: relative;
      padding: 40px 20px;
      line-height: 1.6;
      color: #555;
    }

    /* Simple background */
    .background-simple {
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
      color: #333;
    }
    .background-simple h2 { font-size: 2.2em; margin-bottom: 10px; }
    .background-simple p { color: #666; }

    /* Talk to Docs Button */
    .talk-to-docs-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 25px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .talk-to-docs-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4); }
    .talk-to-docs-btn:active { transform: translateY(-1px); }

    /* Chat Widget Container */
    .chat-widget {
      position: fixed;
      z-index: 1001;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      display: none;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* Responsive positioning */
    @media (min-width: 1200px) {
      /* Big screen - bottom right */
      .chat-widget { bottom: 30px; right: 30px; width: 400px; height: 600px; }
    }
    @media (min-width: 768px) and (max-width: 1199px) {
      /* Medium screen - bottom half */
      .chat-widget { bottom: 0; left: 0; right: 0; width: 100%; height: 50vh; border-radius: 20px 20px 0 0; }
    }
    @media (max-width: 767px) {
      /* Small screen - full screen */
      .chat-widget { top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; border-radius: 0; }
      .talk-to-docs-btn { bottom: 20px; right: 20px; padding: 12px 20px; font-size: 0.9em; }
    }

    .chat-widget.show { display: flex; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.1em;
      font-weight: 600;
    }
    .chat-header-content { flex: 1; }
    .chat-header-title { font-size: 1.1em; margin-bottom: 2px; }
    .chat-header-subtitle { font-size: 0.75em; opacity: 0.9; }

    .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px; height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2em; transition: background 0.2s ease;
    }
    .close-btn:hover { background: rgba(255, 255, 255, 0.3); }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: #f8f9fa;
    }
    .message { max-width: 80%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; animation: fadeIn 0.3s ease-in; }
    .message.user { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
    .message.ai { background: white; color: #333; align-self: flex-start; border: 1px solid #e9ecef; border-bottom-left-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .message .timestamp { font-size: 0.75em; opacity: 0.7; margin-top: 5px; }

    /* Markdown/code styling */
    .message pre {
      background: #0f172a; /* dark blue-gray */
      color: #e2e8f0;
      padding: 12px 14px;
      border-radius: 10px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9em;
      line-height: 1.45;
      border: 1px solid #0b1220;
    }
    .message code {
      background: #f1f5f9; /* slate-100 */
      color: #0f172a;
      padding: 2px 6px;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95em;
    }
    .message pre code { background: transparent; color: inherit; padding: 0; }

    .typing-indicator { align-self: flex-start; background: white; border: 1px solid #e9ecef; border-radius: 18px; border-bottom-left-radius: 5px; padding: 12px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .typing-dots { display: flex; gap: 4px; }
    .typing-dots span { width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }

    .chat-input-container {
      padding: 20px; background: white; border-top: 1px solid #e9ecef; display: flex; flex-direction: column; gap: 15px;
    }
    .password-container {
      display: flex; gap: 10px; align-items: center;
    }
    .main-input-container {
      display: flex; gap: 10px; align-items: center;
    }
    .chat-input { flex: 1; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 25px; outline: none; font-size: 1em; transition: border-color 0.3s ease; }
    .chat-input:focus { border-color: #667eea; }
    .chat-input:disabled { background: #f8f9fa; cursor: not-allowed; }
    .password-input { 
      flex: 1; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 20px; outline: none; font-size: 0.9em; 
      transition: border-color 0.3s ease; background: #f8f9fa;
    }
    .password-input:focus { border-color: #667eea; }
    .password-label { font-size: 0.85em; color: #666; font-weight: 500; min-width: 60px; }
    .password-toggle { 
      background: none; border: none; color: #666; cursor: pointer; font-size: 0.85em; 
      padding: 4px 8px; border-radius: 12px; transition: background 0.2s ease;
    }
    .password-toggle:hover { background: #f0f0f0; }

    .send-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, opacity 0.3s ease; font-size: 1.1em;
    }
    .send-button:hover:not(:disabled) { transform: scale(1.05); }
    .send-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .status-bar { padding: 8px 20px; background: #f8f9fa; border-top: 1px solid #e9ecef; font-size: 0.8em; color: #666; text-align: center; }
    .status-bar.online { color: #28a745; }
    .status-bar.error { color: #dc3545; }
    .status-bar.loading { color: #007bff; }

    .clear-chat { background: none; border: 1px solid #dc3545; color: #dc3545; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.8em; transition: all 0.3s ease; }
    .clear-chat:hover { background: #dc3545; color: white; }

    .cloud-indicator { background: none; border: 1px solid #28a745; color: #28a745; padding: 6px 12px; border-radius: 15px; font-size: 0.8em; cursor: default; }

    /* Overlay for mobile */
    .chat-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
    @media (max-width: 767px) { .chat-overlay.show { display: block; } }
  </style>
</head>
<body>
  <!-- Background content -->
  <div class="background-simple">
    <h2>Welcome</h2>
    <p>Use the button below to chat with the WCC Storybook Docs Assistant for UPS Angular components.</p>
  </div>

  <!-- Talk to Docs Button -->
  <button class="talk-to-docs-btn" id="talkToDocsBtn" onclick="openChat()">üí¨ Talk to Docs</button>

  <!-- Chat Overlay (for mobile) -->
  <div class="chat-overlay" id="chatOverlay" onclick="closeChat()"></div>

  <!-- Chat Widget -->
  <div class="chat-widget" id="chatWidget">
    <div class="chat-header">
      <div class="chat-header-content">
        <div class="chat-header-title">WCC Docs Assistant</div>
        <div class="chat-header-subtitle">UPS Angular components ‚Ä¢ Storybook</div>
      </div>
      <button class="close-btn" onclick="closeChat()" title="Close chat">‚úï</button>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input-container">
      <!-- Password input -->
      <div class="password-container">
        <span class="password-label">üîê Key:</span>
        <input type="password" class="password-input" id="passwordInput" placeholder="Enter access password..." />
        <button class="password-toggle" onclick="togglePasswordVisibility()" title="Show/Hide password">üëÅÔ∏è</button>
      </div>
      
      <!-- Main input controls -->
      <div class="main-input-container">
        <button class="cloud-indicator" title="Connected to Render cloud">‚òÅÔ∏è</button>
        <button class="clear-chat" onclick="clearChat()" title="Clear chat history">üóëÔ∏è</button>
        <input type="text" class="chat-input" id="chatInput" placeholder="Ask about components, inputs/outputs, usage, or stories..." maxlength="500" />
        <button class="send-button" id="sendButton" onclick="sendMessage()">‚û§</button>
      </div>
    </div>

    <div class="status-bar" id="statusBar">Connected to Render cloud ‚Ä¢ Ready to chat</div>
  </div>

  <script>
    // Configuration - Using Render webhook URL
    // const WEBHOOK_URL = 'https://n8n-jmlp.onrender.com/webhook/wcc-docs';
    // const WEBHOOK_URL = 'https://n8n-jmlp.onrender.com/webhook-test/wcc-docs';
    const WEBHOOK_URL = 'https://n8n-jmlp.onrender.com/webhook/wcc-docs-with-auth';
    const STORAGE_KEY = 'wcc_docs_chat_history';

    // DOM elements
    const chatWidget = document.getElementById('chatWidget');
    const chatOverlay = document.getElementById('chatOverlay');
    const talkToDocsBtn = document.getElementById('talkToDocsBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const passwordInput = document.getElementById('passwordInput');
    const sendButton = document.getElementById('sendButton');
    const statusBar = document.getElementById('statusBar');

    // State
    let isLoading = false;
    let isChatOpen = false;

    // Initialize
    window.addEventListener('load', () => {
      // Wait until user opens chat
    });

    // Open chat widget
    function openChat() {
      isChatOpen = true;
      talkToDocsBtn.style.display = 'none';
      chatWidget.classList.add('show');
      if (window.innerWidth <= 767) chatOverlay.classList.add('show');

      loadChatHistory();
      if (chatMessages.children.length === 0) addWelcomeMessage();
      setTimeout(() => chatInput.focus(), 300);
    }

    // Close chat widget
    function closeChat() {
      isChatOpen = false;
      chatWidget.classList.remove('show');
      chatOverlay.classList.remove('show');
      clearChatSession();
      setTimeout(() => (talkToDocsBtn.style.display = 'flex'), 300);
    }

    // Clear chat session
    function clearChatSession() {
      chatMessages.innerHTML = '';
      sessionStorage.removeItem(STORAGE_KEY);
      isLoading = false;
      chatInput.disabled = false;
      sendButton.disabled = false;
      sendButton.innerHTML = '‚û§';
      statusBar.className = 'status-bar';
      statusBar.textContent = 'Connected to Render cloud ‚Ä¢ Ready to chat';
    }

    // Keyboard events
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && isChatOpen && !isLoading && 
          (document.activeElement === chatInput || document.activeElement === passwordInput)) {
        sendMessage();
      }
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isChatOpen) closeChat(); });

    // Password toggle functionality
    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('passwordInput');
      const toggleButton = document.querySelector('.password-toggle');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.textContent = 'üôà';
        toggleButton.title = 'Hide password';
      } else {
        passwordInput.type = 'password';
        toggleButton.textContent = 'üëÅÔ∏è';
        toggleButton.title = 'Show password';
      }
    }

    // Welcome message
    function addWelcomeMessage() {
      const welcomeMessage = {
        type: 'ai',
        content: `üëã Welcome to chat !! Here you can chat with our Web common components doc.\n\nüîê **Authentication Required:** Please enter the access password in the key field above.\n\nFor a quick starter here are few examples:\n\n"ups secondary cta with label : Track Delivery and left icon"`,
        timestamp: new Date().toISOString(),
      };
      displayMessage(welcomeMessage);
      saveChatHistory();
    }

    // Send message
    async function sendMessage() {
      const message = chatInput.value.trim();
      const password = passwordInput.value.trim();
      
      if (!message || isLoading) return;
      
      if (!password) {
        updateStatus('error', 'üîê Please enter the access password');
        passwordInput.focus();
        return;
      }

      setLoading(true);
      const userMessage = { type: 'user', content: message, timestamp: new Date().toISOString() };
      displayMessage(userMessage);
      chatInput.value = '';
      showTypingIndicator();

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 45000);

        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            password: password,
            query: message, 
            chatInput: message 
          }),
          signal: controller.signal,
        });

        clearTimeout(timeoutId);
        hideTypingIndicator();

        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Invalid password. Access denied to this workflow.');
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.text();
        let aiResponse;
        try {
          const jsonData = JSON.parse(data);
          if (Array.isArray(jsonData)) {
            const first = jsonData[0] || {};
            aiResponse = first.output || first.response || first.message || JSON.stringify(jsonData, null, 2);
          } else if (typeof jsonData === 'object' && jsonData !== null) {
            aiResponse = jsonData.output || jsonData.response || jsonData.message || JSON.stringify(jsonData, null, 2);
          } else {
            aiResponse = String(jsonData);
          }
        } catch {
          aiResponse = data;
        }

        // Convert escaped newlines to actual newlines for proper markdown processing
        aiResponse = aiResponse.replace(/\\n/g, '\n');

        const aiMessage = { type: 'ai', content: aiResponse, timestamp: new Date().toISOString() };
        displayMessage(aiMessage);
        updateStatus('online', '‚úÖ Response from Render cloud');
      } catch (error) {
        console.error('Error:', error);
        hideTypingIndicator();
        const errorContent = error.name === 'AbortError'
          ? '‚è∞ Request timed out after 45 seconds. The cloud service may be experiencing delays.'
          : `‚ùå Sorry, I encountered an error: ${error.message}`;
        const errorMessage = {
          type: 'ai',
          content: `${errorContent}\n\nüîß Troubleshooting tips:\n‚Ä¢ Check your internet connection\n‚Ä¢ Verify the password is correct\n‚Ä¢ Verify the Render service is running: n8n-jmlp.onrender.com\n‚Ä¢ Cloud services may take longer to respond\n‚Ä¢ Try again in a few moments\n‚Ä¢ The n8n workflow might need to be activated`,
          timestamp: new Date().toISOString(),
        };
        displayMessage(errorMessage);
        updateStatus('error', `‚ùå Error: ${error.message}`);
      }

      setLoading(false);
      saveChatHistory();
    }

    // Display message
    function displayMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${message.type}`;
      messageDiv.dataset.raw = message.content || '';
      messageDiv.dataset.ts = message.timestamp || new Date().toISOString();
      const timestamp = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const html = renderMarkdownToHtml(message.content || '');
      messageDiv.innerHTML = `<div>${html}</div><div class="timestamp">${timestamp}</div>`;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    function escapeHtml(str) {
      return (str || '').replace(/[&<>"']/g, (ch) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[ch]));
    }

    // Minimal Markdown renderer with fenced code blocks and inline code
    function renderMarkdownToHtml(text) {
      if (!text) return '';
      let idx = 0;
      const blocks = [];
      let working = text.replace(/\r\n/g, '\n');

      // Extract fenced code blocks and replace with placeholders
      working = working.replace(/```([\w-]+)?\n([\s\S]*?)```/g, (m, lang, code) => {
        const id = `__CODEBLOCK_${idx++}__`;
        const html = `<pre><code${lang ? ` class="language-${lang}"` : ''}>${escapeHtml(code)}</code></pre>`;
        blocks.push({ id, html });
        return id;
      });

      // Escape remaining text to avoid HTML injection
      working = escapeHtml(working);

      // Inline code
      working = working.replace(/`([^`]+)`/g, (m, code) => `<code>${code}</code>`);

      // Bold/italic
      working = working
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>');

      // Bullets
      working = working.replace(/^‚Ä¢ (.*)$/gim, '&bull; $1');

      // Newlines
      working = working.replace(/\n/g, '<br>');

      // Restore code blocks
      for (const ph of blocks) {
        working = working.replace(ph.id, ph.html);
      }

      return working;
    }

    // Typing indicator
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typingIndicator';
      typingDiv.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
      chatMessages.appendChild(typingDiv);
      scrollToBottom();
    }
    function hideTypingIndicator() { const el = document.getElementById('typingIndicator'); if (el) el.remove(); }

    // Loading state
    function setLoading(loading) {
      isLoading = loading;
      chatInput.disabled = loading;
      passwordInput.disabled = loading;
      sendButton.disabled = loading;
      if (loading) { updateStatus('loading', '‚òÅÔ∏è Connecting to Render cloud...'); sendButton.innerHTML = '‚è≥'; }
      else { sendButton.innerHTML = '‚û§'; if (isChatOpen) chatInput.focus(); }
    }

    // Status bar
    function updateStatus(type, message) {
      statusBar.className = `status-bar ${type}`;
      statusBar.textContent = message;
      if (type !== 'loading') setTimeout(() => { statusBar.className = 'status-bar'; statusBar.textContent = 'Connected to Render cloud ‚Ä¢ Ready to chat'; }, 5000);
    }

    // Scroll to bottom
    function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }

    // Persist chat in session storage
    function saveChatHistory() {
      const messages = Array.from(chatMessages.children)
        .filter((msg) => msg.id !== 'typingIndicator')
        .map((msg) => {
          const isUser = msg.classList.contains('user');
          const raw = msg.dataset.raw || '';
          const ts = msg.dataset.ts || new Date().toISOString();
          return { type: isUser ? 'user' : 'ai', content: raw, timestamp: ts };
        });
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
    }

    function loadChatHistory() {
      const saved = sessionStorage.getItem(STORAGE_KEY);
      if (!saved) return;
      try { JSON.parse(saved).forEach((m) => displayMessage(m)); } catch (e) { console.error('History load error', e); }
    }

    // Clear chat (button)
    function clearChat() {
      if (!confirm('Clear the chat history?')) return;
      chatMessages.innerHTML = '';
      sessionStorage.removeItem(STORAGE_KEY);
      addWelcomeMessage();
      saveChatHistory();
      updateStatus('online', 'üóëÔ∏è Chat history cleared');
    }

    // Resize handler for overlay
    window.addEventListener('resize', () => {
      if (!isChatOpen) return;
      if (window.innerWidth <= 767) chatOverlay.classList.add('show'); else chatOverlay.classList.remove('show');
    });
  </script>
</body>
</html>
